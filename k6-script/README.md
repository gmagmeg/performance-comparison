# K6è² è·è¨ˆæ¸¬ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯è¤‡æ•°ã®PHPå®Ÿè¡Œç’°å¢ƒã«å¯¾ã—ã¦è² è·è¨ˆæ¸¬ã‚’è¡Œã†ãŸã‚ã®K6ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚

## ğŸ†• æ–°ã—ã„è² è·è¨ˆæ¸¬ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ¨å¥¨ï¼‰

### `01-load-script.js` - è»½è² è·ã€œé«˜è² è·ãƒ†ã‚¹ãƒˆå¯¾å¿œ

è»½è² è·ã€ä¸­è² è·ã€é«˜è² è·ã®3ã¤ã®ã‚·ãƒŠãƒªã‚ªã«å¯¾å¿œã—ãŸæ–°ã—ã„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚

#### ç°¡å˜å®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰

```bash
# 01-load-scriptãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd 01-load-script

# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
./run-load-test.sh --help

# è»½è² è·ãƒ†ã‚¹ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
./run-load-test.sh frankenphp lightweight

# ä¸­è² è·ãƒ†ã‚¹ãƒˆ
./run-load-test.sh frankenphp medium

# é«˜è² è·ãƒ†ã‚¹ãƒˆ  
./run-load-test.sh swoole-php heavy
```

#### æ‰‹å‹•å®Ÿè¡Œ

```bash
# 01-load-scriptãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd 01-load-script

# è»½è² è·ãƒ†ã‚¹ãƒˆï¼ˆ1-10ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€5åˆ†ï¼‰
k6 run -e ENV=frankenphp -e SCENARIO=lightweight 01-load-script.js

# ä¸­è² è·ãƒ†ã‚¹ãƒˆï¼ˆ50-100ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€10åˆ†ï¼‰
k6 run -e ENV=frankenphp -e SCENARIO=medium 01-load-script.js

# é«˜è² è·ãƒ†ã‚¹ãƒˆï¼ˆ200-500ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€15åˆ†ï¼‰
k6 run -e ENV=frankenphp -e SCENARIO=heavy 01-load-script.js
```

#### ã‚·ãƒŠãƒªã‚ªè¨­å®šã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

`load-scenarios.json`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ã§ã€å„ã‚·ãƒŠãƒªã‚ªã®è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã™ï¼š

```json
{
  "scenarios": {
    "lightweight": {
      "stages": [
        { "duration": "30s", "target": 1 },
        { "duration": "4m", "target": 10 },
        { "duration": "30s", "target": 0 }
      ]
    }
  }
}
```

## å¯¾å¿œç’°å¢ƒ

| ç’°å¢ƒå | ãƒãƒ¼ãƒˆ | èª¬æ˜ |
|--------|--------|------|
| apache-php | 9100 | Apache + PHPç’°å¢ƒ |
| nginx-fpm | 9200 | Nginx + PHP-FPMç’°å¢ƒ |
| frankenphp | 9400 | FrankenPHPç’°å¢ƒ |
| swoole-php | 9300 | Swoole + PHPç’°å¢ƒ |

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬çš„ãªå®Ÿè¡Œæ–¹æ³•

```bash
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç’°å¢ƒï¼ˆapache-phpï¼‰ã§å®Ÿè¡Œ
k6 run k6-script.js

# ç‰¹å®šã®ç’°å¢ƒã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œ
k6 run -e ENV=frankenphp k6-script.js
k6 run -e ENV=nginx-fpm k6-script.js
k6 run -e ENV=swoole-php k6-script.js
```

### çµæœã‚’InfluxDBã«é€ä¿¡ã™ã‚‹å ´åˆ

```bash
k6 run -e ENV=frankenphp --out influxdb=http://localhost:8086/k6 k6-script.js
```

## è² è·è¨­å®š

ç¾åœ¨ã®è¨­å®š:
- 5ç§’ã§1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ã§ä¸Šæ˜‡
- ã‚ˆã‚Šé«˜ã„è² è·ã‚’ã‹ã‘ãŸã„å ´åˆã¯ã€`options.stages`ã®è¨­å®šã‚’å¤‰æ›´ã—ã¦ãã ã•ã„

```javascript
stages: [
  { duration: '5s', target: 1 },   // 5ç§’ã§1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ã§ä¸Šæ˜‡
  { duration: '40s', target: 10 }, // 40ç§’é–“10ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¶­æŒ
  { duration: '10s', target: 0 },  // 10ç§’ã§0ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ã§ä¸‹é™
],
```

## å‰ææ¡ä»¶

- å„ç’°å¢ƒã®Dockerã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨
- å„ç’°å¢ƒã§`/api/lightweight`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒåˆ©ç”¨å¯èƒ½ã§ã‚ã‚‹ã“ã¨

## ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

### äº‹å‰æº–å‚™ï¼šç’°å¢ƒç¢ºèª

```bash
# å…¨ç’°å¢ƒã®èµ·å‹•çŠ¶æ³ç¢ºèªï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã§å®Ÿè¡Œï¼‰
cd ..
chmod +x env-confirm.sh
./env-confirm.sh
```

### ç°¡å˜ãªãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰

```bash
# k6-scriptãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd k6-script

# ç‰¹å®šç’°å¢ƒã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
./run-test.sh apache      # Apacheç’°å¢ƒã®ã¿
./run-test.sh nginx       # Nginxç’°å¢ƒã®ã¿
./run-test.sh swoole      # Swooleç’°å¢ƒã®ã¿
./run-test.sh frankenphp  # FrankenPHPç’°å¢ƒã®ã¿
./run-test.sh all         # å…¨ç’°å¢ƒã‚’é †æ¬¡å®Ÿè¡Œ

# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
./run-test.sh --help
```

### æ‰‹å‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# k6-scriptãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd k6-script

# TypeScriptå‹å®šç¾©ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆåˆå›ã®ã¿ï¼‰
npm install

# ç‰¹å®šç’°å¢ƒã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
k6 run --env TARGET_ENV=apache light-load-test.ts
k6 run --env TARGET_ENV=nginx light-load-test.ts
k6 run --env TARGET_ENV=swoole light-load-test.ts
k6 run --env TARGET_ENV=frankenphp light-load-test.ts

# ã¾ãŸã¯ npm scriptsã‚’ä½¿ç”¨
npm run test:apache
npm run test:nginx
npm run test:swoole
npm run test:frankenphp
npm run test:all  # å…¨ç’°å¢ƒã‚’é †æ¬¡å®Ÿè¡Œ
```

## ãƒ†ã‚¹ãƒˆå†…å®¹

### è»½è² è·ãƒ†ã‚¹ãƒˆä»•æ§˜

- **æ®µéšçš„è² è·**: 5ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ 10ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ 15ãƒ¦ãƒ¼ã‚¶ãƒ¼
- **ãƒ†ã‚¹ãƒˆæ™‚é–“**: åˆè¨ˆ7åˆ†é–“
- **ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³**:
  - 60%: æŠ•ç¨¿ä¸€è¦§å–å¾—ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
  - 25%: å˜ä¸€æŠ•ç¨¿è©³ç´°å–å¾—
  - 15%: å…¨æŠ•ç¨¿ä¸€è¦§å–å¾—ï¼ˆé«˜è² è·å‡¦ç†ï¼‰

### æ€§èƒ½åŸºæº–

- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: 95%ãŒ500msä»¥å†…ã€99%ãŒ1ç§’ä»¥å†…
- **ã‚¨ãƒ©ãƒ¼ç‡**: 1%æœªæº€
- **å„ç¨®API**: ç•°ãªã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã®åŸºæº–

## çµæœã®ç¢ºèª

ãƒ†ã‚¹ãƒˆçµæœã¯ `results/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä»¥ä¸‹ã®å½¢å¼ã§ä¿å­˜ã•ã‚Œã¾ã™ï¼š

```
results/
â”œâ”€â”€ light-load-apache_mod_php-2024-01-XX...json
â”œâ”€â”€ light-load-nginx_php_fpm-2024-01-XX...json
â”œâ”€â”€ light-load-swoole-2024-01-XX...json
â””â”€â”€ light-load-frankenphp-2024-01-XX...json
```

### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ä¾‹

```
=== è»½è² è·ãƒ†ã‚¹ãƒˆçµæœ: Apache+mod_php ===
ãƒ†ã‚¹ãƒˆæ™‚åˆ»: 2024-01-15T10:30:00.000Z
å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: 85.42ms
95%ã‚¿ã‚¤ãƒ«: 156.78ms
99%ã‚¿ã‚¤ãƒ«: 298.45ms
ãƒªã‚¯ã‚¨ã‚¹ãƒˆç·æ•°: 1250
ã‚¨ãƒ©ãƒ¼ç‡: 0.00%
å¹³å‡RPS: 18.52
============================
```

## ãƒ†ã‚¹ãƒˆã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### è² è·ãƒ¬ãƒ™ãƒ«ã®èª¿æ•´

`light-load-test.ts` ã® `stages` ã‚’ä¿®æ­£ï¼š

```typescript
stages: [
  { duration: '2m', target: 20 },   // ã‚ˆã‚Šé«˜ã„è² è·
  { duration: '5m', target: 50 },   // ã•ã‚‰ã«é«˜ã„è² è·
  { duration: '2m', target: 0 },    // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
],
```

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è¿½åŠ 

æ–°ã—ã„ãƒ†ã‚¹ãƒˆé–¢æ•°ã‚’è¿½åŠ ã—ã¦ã€ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã«çµ„ã¿è¾¼ã¿ï¼š

```typescript
function testNewEndpoint(): void {
  // æ–°ã—ã„APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ
}

// ãƒ¡ã‚¤ãƒ³é–¢æ•°å†…ã§å‘¼ã³å‡ºã—
export default function () {
  // ... æ—¢å­˜ã‚³ãƒ¼ãƒ‰
  testNewEndpoint();
}
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ç’°å¢ƒãŒå¿œç­”ã—ãªã„å ´åˆ

```bash
# å„ç’°å¢ƒã®çŠ¶æ…‹ç¢ºèª
curl http://localhost:9100/api/info  # Apache
curl http://localhost:9200/api/info  # Nginx
curl http://localhost:9300/api/info  # Swoole
curl http://localhost:9400/api/info  # FrankenPHP
```

### k6ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ

k6ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼š
https://k6.io/docs/getting-started/installation/

### TypeScriptã‚¨ãƒ©ãƒ¼ã®å ´åˆ

```bash
npm install  # å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```

## é«˜è² è·ãƒ†ã‚¹ãƒˆã¸ã®ç™ºå±•

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ã‚ˆã‚Šé«˜ã„è² è·ã®ãƒ†ã‚¹ãƒˆã‚’ä½œæˆå¯èƒ½ï¼š

1. **ä¸­è² è·ãƒ†ã‚¹ãƒˆ**: 50-100ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€10åˆ†é–“
2. **é«˜è² è·ãƒ†ã‚¹ãƒˆ**: 200-500ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€15åˆ†é–“
3. **ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ**: æ®µéšçš„ã«è² è·ã‚’å¢—åŠ ã—ã¦é™ç•Œã‚’æ¸¬å®š 